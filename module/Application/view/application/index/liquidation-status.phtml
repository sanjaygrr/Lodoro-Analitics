<!-- module/Application/view/application/index/liquidation-status.phtml -->
<!DOCTYPE html>
<html>
<head>
    <title>Procesando Liquidación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        .status-container {
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
        }
        .progress {
            height: 30px;
            width: 100%;
            margin: 20px 0;
        }
        .status-message {
            font-size: 1.2em;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-container">
            <h2>Procesando Liquidación</h2>
            <p class="status-message" id="statusMessage">
                <?php if ($job['status'] == 'pending'): ?>
                    Iniciando procesamiento...
                <?php elseif ($job['status'] == 'processing'): ?>
                    Procesando archivo... <?= $job['progress'] ?>%
                <?php elseif ($job['status'] == 'completed'): ?>
                    ¡Procesamiento completado!
                <?php elseif ($job['status'] == 'failed'): ?>
                    Error en el procesamiento
                <?php endif; ?>
            </p>
            
            <?php if ($job['status'] != 'completed' && $job['status'] != 'failed'): ?>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: <?= $job['progress'] ?? 0 ?>%"
                         aria-valuenow="<?= $job['progress'] ?? 0 ?>" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <?= $job['progress'] ?? 0 ?>%
                    </div>
                </div>
                
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
            <?php endif; ?>
            
            <?php if (isset($job['error_message']) && $job['error_message']): ?>
                <div class="alert alert-danger mt-3">
                    <?= $this->escapeHtml($job['error_message']) ?>
                </div>
            <?php endif; ?>
            
            <?php if ($job['status'] == 'completed' || $job['status'] == 'failed'): ?>
                <a href="<?= $this->url('application', ['action' => 'detail', 'table' => 'liquidaciones_paris']) ?>" 
                   class="btn btn-primary mt-3">
                    Volver
                </a>
            <?php endif; ?>
        </div>
    </div>
    
    <script>
        // Actualizar estado cada 2 segundos
        <?php if ($job['status'] != 'completed' && $job['status'] != 'failed'): ?>
        setInterval(function() {
            fetch('/application/get-liquidation-status?id=<?= $jobId ?>')
                .then(response => response.json())
                .then(data => {
                    const progressBar = document.querySelector('.progress-bar');
                    const statusMessage = document.getElementById('statusMessage');
                    
                    if (progressBar) {
                        progressBar.style.width = data.progress + '%';
                        progressBar.setAttribute('aria-valuenow', data.progress);
                        progressBar.textContent = data.progress + '%';
                    }
                    
                    if (data.status == 'completed' || data.status == 'failed') {
                        window.location.reload();
                    }
                    
                    // Actualizar mensaje
                    if (data.status == 'processing') {
                        statusMessage.textContent = 'Procesando archivo... ' + data.progress + '%';
                    }
                });
        }, 2000);
        <?php endif; ?>
    </script>
</body>
</html>