<?php
/**
 * @var Laminas\View\Renderer\PhpRenderer $this
 */
?>
<?= $this->doctype() ?>
<html lang="es" data-theme="light">
    <head>
        <meta charset="utf-8">
        <?= $this->headTitle('Lodoro Analytics')->setSeparator(' - ')->setAutoEscape(false) ?>

        <?= $this->headMeta()
            ->appendName('viewport', 'width=device-width, initial-scale=1.0')
            ->appendHttpEquiv('X-UA-Compatible', 'IE=edge')
        ?>

        <!-- Favicon y estilos base -->
        <?= $this->headLink([
                'rel'  => 'shortcut icon',
                'type' => 'image/vnd.microsoft.icon',
                'href' => $this->basePath() . '/img/favicon.ico'
            ])
            ->prependStylesheet($this->basePath('css/style.css'))
            ->prependStylesheet($this->basePath('css/bootstrap.min.css'))
        ?>

        <!-- Font Awesome para iconos -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        
        <!-- Google Fonts - Inter -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

        <!-- Estilos personalizados -->
        <style>
           /* Light Mode Colors */
:root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --primary-dark: #3f37c9;
    --secondary: #6c757d;
    --success: #4caf50;
    --danger: #f44336;
    --warning: #ff9800;
    --info: #2196f3;
    --background: #f5f7fb;
    --header-bg: #ffffff;
    --sidebar-bg: #ffffff;
    --card-bg: #ffffff;
    --text-main: #3b3f5c;
    --text-muted: #6c757d;
    --text-light: #cbd5e1;
    --border-color: #e0e6ed;
    --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    --overlay-bg: rgba(0, 0, 0, 0.5);
    --sidebar-active: #eef2ff;
    --sidebar-hover: #f1f3fa;
    --transition-speed: 0.3s;
    /* Light mode specific variables */
    --card-header-bg: #f8f9fa;
    --card-header-text: #3b3f5c;
    --input-bg: #ffffff;
    --input-border: #ced4da;
    --input-text: #212529;
    --link-color: #4361ee;
    --strong-text: #212529;
    --table-header-bg: #f8f9fa;
    --table-border: #dee2e6;
    --table-hover: #f8f9fa;
    --table-active: #e9ecef;
}

/* Dark Mode Colors */
html[data-theme="dark"] {
    --primary: #6366f1;
    --primary-light: #818cf8;
    --primary-dark: #4f46e5;
    --background: #1e1e2d;
    --header-bg: #151521;
    --sidebar-bg: #151521;
    --card-bg: #1e1e2d;
    --text-main: #e2e8f0;
    --text-muted: #94a3b8;
    --text-light: #cbd5e1;
    --border-color: #30304d;
    --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.15);
    --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.25);
    --sidebar-active: #2a2b41;
    --sidebar-hover: #252636;
    /* Dark mode specific variables */
    --card-header-bg: #252636;
    --card-header-text: #e2e8f0;
    --input-bg: #252636;
    --input-border: #30304d;
    --input-text: #e2e8f0;
    --link-color: #818cf8;
    --strong-text: #ffffff;
    --table-header-bg: #252636;
    --table-border: #30304d;
    --table-hover: #272639;
    --table-active: #292b45;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--background);
    color: var(--text-main);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    transition: background-color var(--transition-speed) ease, 
                color var(--transition-speed) ease;
    min-height: 100vh;
}

/* Contenedor principal */
.app-container {
    display: flex;
    min-height: 100vh;
    position: relative;
}

/* Header principal */
.main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background-color: var(--header-bg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    box-shadow: var(--shadow-sm);
    z-index: 9999 !important;
    transition: background-color var(--transition-speed) ease;
    border-bottom: 1px solid var(--border-color);
}

/* Header children */
.header-left {
    display: flex;
    align-items: center;
    position: relative;
    z-index: 10000;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    z-index: 10000;
}

/* Menu toggle */
.menu-toggle {
    background: none;
    border: none;
    color: var(--text-main);
    font-size: 1.25rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    margin-right: 1rem;
    position: relative;
    z-index: 10001;
    pointer-events: auto;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
}

.menu-toggle:hover {
    background-color: var(--sidebar-hover);
}

.app-logo {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-main);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color var(--transition-speed) ease;
}

.app-logo i {
    color: var(--primary);
}

.app-logo:hover {
    color: var(--primary);
}

/* Botón de tema (dark/light) */
.theme-toggle {
    background: none;
    border: none;
    color: var(--text-main);
    font-size: 1.25rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    position: relative;
    z-index: 10001;
    pointer-events: auto;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
}

.theme-toggle:hover {
    background-color: var(--sidebar-hover);
}

html[data-theme="light"] .theme-toggle .fa-sun {
    display: none;
}

html[data-theme="dark"] .theme-toggle .fa-moon {
    display: none;
}

/* Dropdown del usuario */
.user-dropdown {
    position: relative;
}

.user-dropdown-toggle {
    background: none;
    border: none;
    color: var(--text-main);
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 0.25rem;
    position: relative;
    z-index: 10001;
    pointer-events: auto;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
}

.user-dropdown-toggle:hover {
    background-color: var(--sidebar-hover);
}

.user-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.user-name {
    display: none;
}

@media (min-width: 576px) {
    .user-name {
        display: block;
    }
}

.user-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    width: 200px;
    background-color: var(--card-bg);
    border-radius: 0.5rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    display: none;
    z-index: 10003;
    margin-top: 0.5rem;
    border: 1px solid var(--border-color);
    transition: background-color var(--transition-speed) ease;
}

.user-dropdown-menu.show {
    display: block;
}

.user-dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: var(--text-main);
    text-decoration: none;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
}

.user-dropdown-menu a:hover {
    background-color: var(--sidebar-hover);
}

.user-dropdown-menu .divider {
    height: 1px;
    background-color: var(--border-color);
    margin: 0.25rem 0;
    transition: background-color var(--transition-speed) ease;
}

/* Sidebar */
.sidebar {
    position: fixed;
    top: 60px;
    left: 0;
    width: 260px;
    height: calc(100vh - 60px);
    background-color: var(--sidebar-bg);
    box-shadow: var(--shadow);
    transform: translateX(-100%);
    transition: transform var(--transition-speed) ease,
                background-color var(--transition-speed) ease;
    z-index: 1020;
    overflow-y: auto;
    border-right: 1px solid var(--border-color);
}

.sidebar.show {
    transform: translateX(0);
}

.sidebar-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.sidebar-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-main);
    margin: 0;
}

.sidebar-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 0.25rem;
    background: none;
    border: none;
    color: var(--text-main);
    cursor: pointer;
    transition: background-color var(--transition-speed) ease;
}

.sidebar-close:hover {
    background-color: var(--sidebar-hover);
}

.nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
}

.nav-category {
    padding: 0.75rem 1rem 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    font-weight: 600;
}

.nav-item {
    position: relative;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--text-main);
    text-decoration: none;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
}

.nav-link:hover {
    background-color: var(--sidebar-hover);
}

.nav-link.active {
    background-color: var(--sidebar-active);
    color: var(--primary);
    font-weight: 500;
}

.nav-link i.nav-icon {
    margin-right: 0.75rem;
    min-width: 20px;
    text-align: center;
    font-size: 1rem;
}

.nav-link .nav-arrow {
    margin-left: auto;
    transition: transform var(--transition-speed) ease;
    font-size: 0.8rem;
}

.nav-item.open .nav-link .nav-arrow {
    transform: rotate(90deg);
}

.submenu {
    list-style: none;
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--transition-speed) ease;
    background-color: var(--sidebar-hover);
}

.nav-item.open .submenu {
    max-height: 500px;
}

.submenu-link {
    display: block;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    color: var(--text-main);
    text-decoration: none;
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease;
    font-size: 0.9rem;
}

.submenu-link:hover {
    background-color: var(--sidebar-hover);
}

.submenu-link.active {
    color: var(--primary);
    background-color: var(--sidebar-active);
    font-weight: 500;
}

/* Overlay para sidebar */
.sidebar-overlay {
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    height: calc(100% - 60px);
    background-color: var(--overlay-bg);
    z-index: 1010;
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-speed) ease,
                visibility var(--transition-speed) ease;
}

.sidebar-overlay.show {
    opacity: 1;
    visibility: visible;
}

/* Contenido principal */
.main-content {
    flex: 1;
    margin-top: 60px;
    padding: 1.5rem;
    width: 100%;
    position: relative;
    z-index: 1;
    transition: background-color var(--transition-speed) ease;
}

/* Responsive */
@media (min-width: 992px) {
    .sidebar {
        width: 260px;
    }
}

/* Transición para todos los elementos afectados por dark mode */
.card, 
.table, 
input, 
select, 
textarea, 
button,
.dropdown-menu,
.modal-content {
    transition: background-color var(--transition-speed) ease,
                color var(--transition-speed) ease,
                border-color var(--transition-speed) ease;
}

/* Asegurar que ningún elemento bloquee el header */
* {
    pointer-events: auto;
}

div, section, article, main, .content, .container {
    position: relative;
    z-index: 0;
}

/* Dark Mode Overrides for Bootstrap Components */
html[data-theme="dark"] .card {
    background-color: var(--card-bg);
    border-color: var(--border-color);
}

html[data-theme="dark"] .card-header.bg-light {
    background-color: var(--card-header-bg) !important;
    color: var(--card-header-text);
    border-bottom-color: var(--border-color);
}

html[data-theme="dark"] .card-title,
html[data-theme="dark"] .card-body {
    color: var(--text-main);
}

html[data-theme="dark"] strong,
html[data-theme="dark"] .fw-bold,
html[data-theme="dark"] .fw-semibold {
    color: var(--strong-text);
}

html[data-theme="dark"] a:not(.btn) {
    color: var(--link-color);
}

html[data-theme="dark"] a:not(.btn):hover {
    color: var(--primary-light);
}

html[data-theme="dark"] .form-control,
html[data-theme="dark"] .form-select {
    background-color: var(--input-bg);
    border-color: var(--input-border);
    color: var(--input-text);
}

html[data-theme="dark"] .table {
    color: var(--text-main);
    border-color: var(--table-border);
}

html[data-theme="dark"] .table thead th {
    background-color: var(--table-header-bg);
    border-color: var(--table-border);
    color: var(--card-header-text);
}

html[data-theme="dark"] .table td {
    border-color: var(--table-border);
}

html[data-theme="dark"] .table-hover tbody tr:hover {
    background-color: var(--table-hover);
}

html[data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, 0.05);
}

html[data-theme="dark"] .bg-light {
    background-color: var(--card-header-bg) !important;
}

html[data-theme="dark"] .text-muted {
    color: var(--text-muted) !important;
}

html[data-theme="dark"] .border {
    border-color: var(--border-color) !important;
}

/* Fix for badge visibility in dark mode */
html[data-theme="dark"] .badge.bg-light {
    background-color: #4a4a6a !important;
    color: var(--text-main) !important;
}

/* Additional fixes for form inputs */
html[data-theme="dark"] input::placeholder,
html[data-theme="dark"] textarea::placeholder,
html[data-theme="dark"] select::placeholder {
    color: var(--text-muted);
}

html[data-theme="dark"] .form-check-input {
    background-color: var(--input-bg);
    border-color: var(--input-border);
}

html[data-theme="dark"] .form-check-input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
}

/* Fix for alert colors in dark mode */
html[data-theme="dark"] .alert {
    border-color: var(--border-color);
}

html[data-theme="dark"] .alert-info {
    background-color: rgba(33, 150, 243, 0.15);
    color: #8ec6f5;
}

html[data-theme="dark"] .alert-success {
    background-color: rgba(76, 175, 80, 0.15);
    color: #8eda92;
}

html[data-theme="dark"] .alert-warning {
    background-color: rgba(255, 152, 0, 0.15);
    color: #ffc166;
}

html[data-theme="dark"] .alert-danger {
    background-color: rgba(244, 67, 54, 0.15);
    color: #f77066;
}

/* Fix for modal in dark mode */
html[data-theme="dark"] .modal-content {
    background-color: var(--card-bg);
    border-color: var(--border-color);
}

html[data-theme="dark"] .modal-header,
html[data-theme="dark"] .modal-footer {
    border-color: var(--border-color);
}

/* Fix for code blocks in dark mode */
html[data-theme="dark"] code,
html[data-theme="dark"] pre {
    background-color: var(--card-header-bg);
    color: #e83e8c;
    border-color: var(--border-color);
}

/* Fix for dropdown menus in dark mode */
html[data-theme="dark"] .dropdown-menu {
    background-color: var(--card-bg);
    border-color: var(--border-color);
}

html[data-theme="dark"] .dropdown-item {
    color: var(--text-main);
}

html[data-theme="dark"] .dropdown-item:hover,
html[data-theme="dark"] .dropdown-item:focus {
    background-color: var(--sidebar-hover);
    color: var(--text-main);
}

html[data-theme="dark"] .dropdown-divider {
    border-color: var(--border-color);
}

/* Fix for pagination in dark mode */
html[data-theme="dark"] .pagination {
    --bs-pagination-bg: var(--card-bg);
    --bs-pagination-border-color: var(--border-color);
    --bs-pagination-color: var(--text-main);
    --bs-pagination-hover-bg: var(--sidebar-hover);
    --bs-pagination-hover-color: var(--primary-light);
    --bs-pagination-active-bg: var(--primary);
    --bs-pagination-active-border-color: var(--primary);
    --bs-pagination-disabled-bg: var(--card-header-bg);
    --bs-pagination-disabled-color: var(--text-muted);
}

/* Fix for list groups in dark mode */
html[data-theme="dark"] .list-group-item {
    background-color: var(--card-bg);
    border-color: var(--border-color);
    color: var(--text-main);
}

html[data-theme="dark"] .list-group-item-action:hover,
html[data-theme="dark"] .list-group-item-action:focus {
    background-color: var(--sidebar-hover);
    color: var(--text-main);
}

/* Specific fixes for breadcrumbs in dark mode */
html[data-theme="dark"] .breadcrumb {
    background-color: var(--card-header-bg);
}

html[data-theme="dark"] .breadcrumb-item.active {
    color: var(--text-muted);
}

/* Fix for buttons in dark mode that use -light variant */
html[data-theme="dark"] .btn-light,
html[data-theme="dark"] .btn-outline-light {
    color: var(--text-main);
    background-color: var(--card-header-bg);
    border-color: var(--border-color);
}

html[data-theme="dark"] .btn-light:hover,
html[data-theme="dark"] .btn-outline-light:hover {
    background-color: var(--sidebar-hover);
    border-color: var(--primary-light);
}

/* Fix for progress bars in dark mode */
html[data-theme="dark"] .progress {
    background-color: var(--card-header-bg);
}

/* Fix for card footers in dark mode */
html[data-theme="dark"] .card-footer {
    background-color: var(--card-header-bg);
    border-top-color: var(--border-color);
}

/* Fix for popovers in dark mode */
html[data-theme="dark"] .popover {
    background-color: var(--card-bg);
    border-color: var(--border-color);
}

html[data-theme="dark"] .popover-header {
    background-color: var(--card-header-bg);
    border-bottom-color: var(--border-color);
}

html[data-theme="dark"] .popover-body {
    color: var(--text-main);
}

/* Tooltip adjustments for dark mode */
html[data-theme="dark"] .tooltip {
    --bs-tooltip-bg: var(--dark);
    --bs-tooltip-color: var(--light);
}
        </style>

        <?= $this->headScript() ?>
    </head>
    <body>
        <?php if ($this->layout()->getTemplate() !== 'layout/login'): ?>
        <!-- Contenido normal del layout para páginas que no son login -->
        <div class="app-container">
            <!-- Header principal -->
            <header class="main-header" style="z-index: 9999 !important; position: fixed !important;">
                <div class="header-left">
                    <button type="button" id="menuToggle" class="menu-toggle" 
                            style="z-index: 10002 !important; position: relative !important; pointer-events: auto !important;"
                            aria-label="Abrir menú">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="<?= $this->url('home') ?>" class="app-logo">
                        <i class="fas fa-chart-line"></i>
                        <span>Lodoro Analytics</span>
                    </a>
                </div>
                <div class="header-right">
                    <button type="button" id="themeToggle" class="theme-toggle" 
                            style="z-index: 10001 !important; position: relative !important; pointer-events: auto !important;"
                            aria-label="Cambiar tema">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </button>
                    <div class="user-dropdown">
                        <button type="button" id="userDropdownToggle" class="user-dropdown-toggle"
                                style="z-index: 10001 !important; position: relative !important; pointer-events: auto !important;">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <?php if ($this->authenticationService()->hasIdentity()): ?>
                                <?php 
                                // Obtener datos del usuario desde el contenedor de sesión
                                $userSession = new \Laminas\Session\Container('user');
                                $username = $userSession->username ?? $this->authenticationService()->getIdentity();
                                ?>
                                <span class="user-name"><?= $this->escapeHtml($username) ?></span>
                            <?php else: ?>
                                <span class="user-name">Invitado</span>
                            <?php endif; ?>
                            <i class="fas fa-chevron-down ms-1"></i>
                        </button>
                        <div id="userDropdownMenu" class="user-dropdown-menu">
                            <?php if ($this->authenticationService()->hasIdentity()): ?>
                                <a href="<?= $this->url('dashboard') ?>">
                                    <i class="fas fa-user-circle"></i>
                                    <span>Mi Perfil</span>
                                </a>
                                <div class="divider"></div>
                                <a href="<?= $this->url('logout') ?>">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Cerrar sesión</span>
                                </a>
                            <?php else: ?>
                                <a href="<?= $this->url('login') ?>">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>Iniciar sesión</span>
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Sidebar / Menú lateral -->
            <aside id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h3>Menú Principal</h3>
                    <button type="button" id="sidebarClose" class="sidebar-close" aria-label="Cerrar menú">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <ul class="nav-menu">
                    <!-- SECCIÓN 1: ANÁLISIS DE VENTAS -->
                    <li class="nav-category">Análisis</li>
                    
                    <li class="nav-item" id="salesAnalysisItem">
                        <a href="#" class="nav-link">
                            <i class="fas fa-chart-bar nav-icon"></i>
                            <span>Análisis de Ventas</span>
                            <i class="fas fa-chevron-right nav-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="<?= $this->url('dashboard') ?>" class="submenu-link <?= $this->url('dashboard') === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Resumen de ventas
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_WALLMART']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_WALLMART']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Walmart
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_RIPLEY']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_RIPLEY']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Ripley
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_FALABELLA']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_FALABELLA']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Falabella
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_MERCADO_LIBRE']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_MERCADO_LIBRE']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Mercado Libre
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_PARIS']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_PARIS']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Paris
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_WOOCOMMERCE']) ?>" class="submenu-link <?= $this->url('dashboard', ['action' => 'detail', 'marketplace' => 'MKP_WOOCOMMERCE']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    WooCommerce
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- SECCIÓN 2: ÓRDENES Y PEDIDOS -->
                    <li class="nav-category">Operaciones</li>
                    
                    <li class="nav-item" id="ordersItem">
                        <a href="#" class="nav-link">
                            <i class="fas fa-shopping-cart nav-icon"></i>
                            <span>Órdenes y Pedidos</span>
                            <i class="fas fa-chevron-right nav-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_WALLMART']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_WALLMART']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Walmart
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_RIPLEY']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_RIPLEY']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Ripley
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_FALABELLA']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_FALABELLA']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Falabella
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_MERCADO_LIBRE']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_MERCADO_LIBRE']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Mercado Libre
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_PARIS']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_PARIS']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    Paris
                                </a>
                            </li>
                            <li>
                                <a href="<?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_WOOCOMMERCE']) ?>" class="submenu-link <?= $this->url('orders', ['action' => 'orders-detail', 'table' => 'Orders_WOOCOMMERCE']) === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                                    WooCommerce
                                </a>
                            </li>
                        </ul>
                    </li>
                    <!-- Agregar dentro de la sección de elementos del menú, después de "Órdenes y Pedidos" -->
                    <li class="nav-item">
                        <a href="<?= $this->url('scan-orders') ?>" class="nav-link <?= $this->url('scan-orders') === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                            <i class="fas fa-barcode nav-icon"></i>
                            <span>Escáner de Órdenes</span>
                        </a>
                    </li>
                                        <!-- SECCIÓN 3: INTEGRACIONES -->
                    <li class="nav-category">Sistema</li>
                    
                    <li class="nav-item">
                        <a href="<?= $this->url('marketplace') ?>" class="nav-link <?= $this->url('marketplace') === $_SERVER['REQUEST_URI'] ? 'active' : '' ?>">
                            <i class="fas fa-plug nav-icon"></i>
                            <span>Integraciones</span>
                        </a>
                    </li>
                </ul>
            </aside>
            
            <!-- Overlay para sidebar -->
            <div id="sidebarOverlay" class="sidebar-overlay"></div>
            
            <!-- Contenido principal -->
            <main class="main-content">
                <?= $this->content ?>
            </main>
        </div>
        <?php else: ?>
        <!-- Layout para la página de login -->
        <?= $this->content ?>
        <?php endif; ?>

        <?= $this->inlineScript()
            ->prependFile($this->basePath('js/bootstrap.min.js')) 
        ?>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Script para la funcionalidad del navbar - CORREGIDO -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Elementos del DOM
                const menuToggle = document.getElementById('menuToggle');
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const sidebarClose = document.getElementById('sidebarClose');
                const themeToggle = document.getElementById('themeToggle');
                const userDropdownToggle = document.getElementById('userDropdownToggle');
                const userDropdownMenu = document.getElementById('userDropdownMenu');
                const salesAnalysisItem = document.getElementById('salesAnalysisItem');
                const ordersItem = document.getElementById('ordersItem');
                
                // Verificar si estamos en la página de login
                const isLoginPage = document.querySelector('.login-container') !== null;
                
                // Si estamos en la página de login, no ejecutamos el código del sidebar
                if (isLoginPage) return;
                
                // Debug para verificar existencia de elementos
                console.log('Elementos encontrados:', {
                    menuToggle: !!menuToggle,
                    sidebar: !!sidebar,
                    sidebarOverlay: !!sidebarOverlay,
                    sidebarClose: !!sidebarClose
                });
                
                // Verificar existencia de elementos críticos
                if (!sidebar || !menuToggle) {
                    console.error("Elementos críticos del sidebar no encontrados");
                    return;
                }
                
                // SOLUCIÓN FORZADA: Asegurar que los elementos sean clickeables
                menuToggle.style.zIndex = '10002';
                menuToggle.style.position = 'relative';
                menuToggle.style.pointerEvents = 'auto';
                menuToggle.style.cursor = 'pointer';
                
                // Inicializar tema
                initTheme();
                
                // Función para alternar la visibilidad del sidebar
                function toggleSidebar(e) {
                    console.log('toggleSidebar llamado');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    sidebar.classList.toggle('show');
                    sidebarOverlay.classList.toggle('show');
                    
                    // Evitar scroll cuando el sidebar está abierto en móviles
                    if (sidebar.classList.contains('show')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                }
                
                // Función para cerrar el sidebar
                function closeSidebar() {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
                
                // Función para alternar un elemento con submenú
                function toggleSubmenu(navItem) {
                    // Cerrar otros submenús si están abiertos
                    const openItems = document.querySelectorAll('.nav-item.open');
                    openItems.forEach(item => {
                        if (item !== navItem) {
                            item.classList.remove('open');
                        }
                    });
                    
                    // Alternar el estado del submenú actual
                    navItem.classList.toggle('open');
                }
                
                // Función para inicializar el tema
                function initTheme() {
                    // Verificar si hay un tema guardado en localStorage
                    const savedTheme = localStorage.getItem('theme');
                    
                    if (savedTheme) {
                        document.documentElement.setAttribute('data-theme', savedTheme);
                    } else {
                        // Verificar preferencia del sistema
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        const themeToSet = prefersDark ? 'dark' : 'light';
                        
                        document.documentElement.setAttribute('data-theme', themeToSet);
                        localStorage.setItem('theme', themeToSet);
                    }
                }
                
                // Función para alternar el tema
                function toggleTheme() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                }
                
                // Función para alternar el menú desplegable del usuario
                function toggleUserDropdown(e) {
                    e.stopPropagation();
                    userDropdownMenu.classList.toggle('show');
                }
                
                // Cerrar el menú desplegable al hacer clic en cualquier otro lugar
                function closeDropdowns(event) {
                    if (userDropdownMenu && userDropdownMenu.classList.contains('show') && 
                        !userDropdownToggle.contains(event.target)) {
                        userDropdownMenu.classList.remove('show');
                    }
                }
                
                // AGREGAR EVENTS DE MÚLTIPLES FORMAS PARA ASEGURAR QUE FUNCIONEN
                if (menuToggle) {
                    // Usar capture true para interceptar el evento
                    menuToggle.addEventListener('click', toggleSidebar, true);
                    menuToggle.addEventListener('touchstart', toggleSidebar, { passive: false });
                    
                    // Fallback: escuchar en el documento
                    document.addEventListener('click', function(e) {
                        if (e.target.id === 'menuToggle' || e.target.closest('#menuToggle')) {
                            console.log('Click detectado en menuToggle (fallback)');
                            toggleSidebar(e);
                        }
                    }, true);
                }
                
                if (sidebarClose) {
                    sidebarClose.addEventListener('click', closeSidebar);
                }
                
                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', closeSidebar);
                }
                
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                if (userDropdownToggle) {
                    userDropdownToggle.addEventListener('click', toggleUserDropdown);
                }
                
                document.addEventListener('click', closeDropdowns);
                
                // Agregar eventos a elementos con submenús
                if (salesAnalysisItem) {
                    const salesAnalysisLink = salesAnalysisItem.querySelector('.nav-link');
                    if (salesAnalysisLink) {
                        salesAnalysisLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            toggleSubmenu(salesAnalysisItem);
                        });
                    }
                }
                
                if (ordersItem) {
                    const ordersLink = ordersItem.querySelector('.nav-link');
                    if (ordersLink) {
                        ordersLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            toggleSubmenu(ordersItem);
                        });
                    }
                }
                setTimeout(() => {
                    const menuToggle = document.getElementById('menuToggle');
                    if (menuToggle) {
                        menuToggle.onclick = function(e) {
                            console.log('Click forzado');
                            document.getElementById('sidebar').classList.toggle('show');
                            document.getElementById('sidebarOverlay').classList.toggle('show');
                        };
                    }
                }, 1000);
                
                // Inicializar submenús activos
                const activeSubmenuItems = document.querySelectorAll('.submenu-link.active');
                activeSubmenuItems.forEach(item => {
                    const parentItem = item.closest('.nav-item');
                    if (parentItem) {
                        parentItem.classList.add('open');
                    }
                });
                
                // Detectar cambios en el esquema de colores del sistema
                const colorSchemeMedia = window.matchMedia('(prefers-color-scheme: dark)');
                colorSchemeMedia.addEventListener('change', function(e) {
                    // Solo cambiar automáticamente si el usuario no ha establecido manualmente un tema
                    const userSetTheme = localStorage.getItem('theme');
                    if (!userSetTheme) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', newTheme);
                    }
                });
                
                // Debug adicional para verificar clics
                document.addEventListener('mousedown', function(e) {
                    console.log('Mousedown en:', e.target);
                    console.log('Z-index del elemento:', window.getComputedStyle(e.target).zIndex);
                }, true);
            });
        </script>
    </body>
</html>