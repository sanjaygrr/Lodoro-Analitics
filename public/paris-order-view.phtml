<?php
/**
 * Versión simplificada de order-detail.phtml para inclusión directa en paris-order.php
 */

// Definir rutas base
$basePath = function($path) {
    return '/Lodoro-Analitics/' . ltrim($path, '/');
};

// Variables para ser usadas en la vista
$orderNumber = $order['suborder_number'] ?? $order['id'] ?? 'N/A';
$marketplaceTitle = 'PARIS';
$marketplaceClass = strtolower($marketplaceTitle);

// Configuración de colores por marketplace
$marketplaceColors = [
    'PARIS' => '#55369c',
    'FALABELLA' => '#007934',
    'RIPLEY' => '#e1022b',
    'MERCADO_LIBRE' => '#ffdb15',
    'WOOCOMMERCE' => '#96588a',
    'WALLMART' => '#0071ce',
    'DEFAULT' => '#4e5bf2',
];

$bgColor = $marketplaceColors[$marketplaceTitle] ?? $marketplaceColors['DEFAULT'];

// Preparar datos de productos
$productos = [];
if (isset($order['productos'])) {
    if (is_string($order['productos'])) {
        $productos = json_decode($order['productos'], true) ?? [];
    } else {
        $productos = $order['productos'];
    }
}

// Detectar el tipo de marketplace
$isParisOrder = $marketplaceTitle === 'PARIS';

// Función para formatear números
$formatNumber = function($number) {
    return number_format((float)$number, 0, ',', '.');
};

// Función para formatear fechas
$formatDate = function($dateString) {
    if (empty($dateString)) return 'N/A';
    $date = new DateTime($dateString);
    return $date->format('d/m/Y H:i');
};

?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle de Orden #<?= $orderNumber ?></title>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="<?= $basePath('css/bootstrap.min.css') ?>">
    <link rel="stylesheet" href="<?= $basePath('css/style.css') ?>">
    <style>
        .marketplace-pill {
            background-color: <?= $bgColor ?>;
        }
        .btn-marketplace {
            background-color: <?= $bgColor ?>;
            border-color: <?= $bgColor ?>;
        }
        .btn-marketplace:hover {
            background-color: <?= $bgColor ?>;
            filter: brightness(90%);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-start">
                    <h1 class="h3 mb-3">
                        Orden #<?= $orderNumber ?> 
                        <span class="badge rounded-pill marketplace-pill"><?= $marketplaceTitle ?></span>
                    </h1>
                    
                    <div class="d-flex">
                        <a href="/Lodoro-Analitics/orders/<?= $table ?>" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        
                        <?php if ($isParisOrder && isset($order['link_boleta']) && !empty($order['link_boleta'])): ?>
                        <a href="<?= $order['link_boleta'] ?>" target="_blank" class="btn btn-outline-primary me-2">
                            <i class="bi bi-file-pdf"></i> Ver Boleta
                        </a>
                        <?php endif; ?>
                        
                        <?php if ($isParisOrder && isset($order['labelUrl']) && !empty($order['labelUrl'])): ?>
                        <a href="<?= $order['labelUrl'] ?>" target="_blank" class="btn btn-outline-primary me-2">
                            <i class="bi bi-tag"></i> Ver Etiqueta
                        </a>
                        <?php endif; ?>
                        
                        <?php if (($order['printed'] ?? 0) == 0): ?>
                        <button class="btn btn-marketplace text-white me-2 btn-marcar-impreso" data-order-id="<?= $order['id'] ?>" data-action="printed">
                            <i class="bi bi-printer"></i> Marcar como Impresa
                        </button>
                        <?php endif; ?>
                        
                        <?php if (($order['printed'] ?? 0) == 1 && ($order['procesado'] ?? 0) == 0): ?>
                        <button class="btn btn-marketplace text-white btn-marcar-procesado" data-order-id="<?= $order['id'] ?>" data-action="processed">
                            <i class="bi bi-check-circle"></i> Marcar como Procesada
                        </button>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas para mostrar mensajes -->
        <div id="alertContainer"></div>

        <div class="row">
            <!-- Columna de datos principales -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">Información de la Orden</h2>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th style="width: 30%">ID:</th>
                                    <td><?= $order['id'] ?? 'N/A' ?></td>
                                </tr>
                                <?php if (isset($order['suborder_number']) && !empty($order['suborder_number'])): ?>
                                <tr>
                                    <th>Suborden:</th>
                                    <td><?= $order['suborder_number'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <tr>
                                    <th>Estado:</th>
                                    <td>
                                        <span class="badge bg-<?= ($order['procesado'] ?? 0) == 1 ? 'success' : (($order['printed'] ?? 0) == 1 ? 'warning' : 'secondary') ?>">
                                            <?= ($order['procesado'] ?? 0) == 1 ? 'Procesada' : (($order['printed'] ?? 0) == 1 ? 'Impresa' : 'Pendiente') ?>
                                        </span>
                                        <?php if (isset($order['estado']) && !empty($order['estado'])): ?>
                                        <span class="badge bg-info ms-1"><?= $order['estado'] ?></span>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                                <?php if (isset($order['fecha_compra']) && !empty($order['fecha_compra'])): ?>
                                <tr>
                                    <th>Fecha de Compra:</th>
                                    <td><?= $formatDate($order['fecha_compra']) ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['fecha_entrega']) && !empty($order['fecha_entrega'])): ?>
                                <tr>
                                    <th>Fecha de Entrega:</th>
                                    <td><?= $formatDate($order['fecha_entrega']) ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['fulfillment']) && !empty($order['fulfillment'])): ?>
                                <tr>
                                    <th>Fulfillment:</th>
                                    <td><?= $order['fulfillment'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['transportista']) && !empty($order['transportista'])): ?>
                                <tr>
                                    <th>Transportista:</th>
                                    <td><?= $order['transportista'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['numero_boleta']) && !empty($order['numero_boleta'])): ?>
                                <tr>
                                    <th>Número de Boleta:</th>
                                    <td><?= $order['numero_boleta'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['total']) && !empty($order['total'])): ?>
                                <tr>
                                    <th>Total:</th>
                                    <td>$<?= $formatNumber($order['total']) ?></td>
                                </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Columna de datos del cliente -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">Información del Cliente</h2>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th style="width: 30%">Nombre:</th>
                                    <td><?= $order['cliente'] ?? 'N/A' ?></td>
                                </tr>
                                <?php if (isset($order['rut_cliente']) && !empty($order['rut_cliente'])): ?>
                                <tr>
                                    <th>RUT:</th>
                                    <td><?= $order['rut_cliente'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['telefono']) && !empty($order['telefono'])): ?>
                                <tr>
                                    <th>Teléfono:</th>
                                    <td><?= $order['telefono'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['direccion']) && !empty($order['direccion'])): ?>
                                <tr>
                                    <th>Dirección:</th>
                                    <td><?= $order['direccion'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['comuna']) && !empty($order['comuna'])): ?>
                                <tr>
                                    <th>Comuna:</th>
                                    <td><?= $order['comuna'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['region']) && !empty($order['region'])): ?>
                                <tr>
                                    <th>Región:</th>
                                    <td><?= $order['region'] ?></td>
                                </tr>
                                <?php endif; ?>
                                <?php if (isset($order['email']) && !empty($order['email'])): ?>
                                <tr>
                                    <th>Email:</th>
                                    <td><?= $order['email'] ?></td>
                                </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">Productos</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>SKU</th>
                                        <th>Nombre</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if (empty($productos)): ?>
                                    <tr>
                                        <td colspan="6" class="text-center">No hay productos disponibles</td>
                                    </tr>
                                    <?php else: ?>
                                    <?php foreach ($productos as $index => $producto): ?>
                                    <tr>
                                        <td><?= $index + 1 ?></td>
                                        <td><?= $producto['sku'] ?? 'N/A' ?></td>
                                        <td><?= $producto['nombre'] ?? 'N/A' ?></td>
                                        <td><?= $producto['cantidad'] ?? 1 ?></td>
                                        <td>$<?= $formatNumber($producto['precio'] ?? $producto['precio_unitario'] ?? 0) ?></td>
                                        <td>$<?= $formatNumber($producto['subtotal'] ?? ($producto['precio'] * ($producto['cantidad'] ?? 1))) ?></td>
                                    </tr>
                                    <?php endforeach; ?>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="<?= $basePath('js/bootstrap.bundle.min.js') ?>"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para mostrar alertas
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }
        
        // Función para marcar como impresa
        const btnsMarcarImpreso = document.querySelectorAll('.btn-marcar-impreso');
        btnsMarcarImpreso.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const action = this.getAttribute('data-action');
                
                fetch(`/Lodoro-Analitics/public/paris-order-action.php?action=${action}&id=${orderId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Orden marcada como impresa correctamente');
                            // Recargar la página después de un breve retraso
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showAlert('Error al marcar la orden: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        showAlert('Error de conexión: ' + error, 'danger');
                    });
            });
        });
        
        // Función para marcar como procesada
        const btnsMarcarProcesado = document.querySelectorAll('.btn-marcar-procesado');
        btnsMarcarProcesado.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const action = this.getAttribute('data-action');
                
                fetch(`/Lodoro-Analitics/public/paris-order-action.php?action=${action}&id=${orderId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Orden marcada como procesada correctamente');
                            // Recargar la página después de un breve retraso
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showAlert('Error al marcar la orden: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        showAlert('Error de conexión: ' + error, 'danger');
                    });
            });
        });
    });
    </script>
</body>
</html>